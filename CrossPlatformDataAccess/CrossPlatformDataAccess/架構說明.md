# CrossPlatformDataAccess 專案架構說明

## 專案結構

```
CrossPlatformDataAccess/
├── Core/                           # 核心層：定義介面和抽象類別
│   ├── DataAccess/                # 資料存取相關介面
│   │   ├── IBaseDataAccess.cs     # 基礎資料存取介面（同步）
│   │   ├── IBaseDataAccessAsync.cs # 基礎資料存取介面（非同步）
│   │   └── IDataAccessStrategy.cs  # 資料存取策略介面
│   ├── Transaction/               # 交易相關介面
│   │   └── ITransactionScope.cs   # 交易範圍介面
│   └── Logging/                   # 日誌相關介面
│       └── ILogger.cs             # 日誌記錄介面
│
├── Infrastructure/                 # 基礎設施層：實作核心層定義的介面
│   ├── DataAccess/               # 資料存取實作
│   │   ├── Base/                 # 基礎類別
│   │   │   └── BaseRepository.cs # 通用儲存庫基礎類別
│   │   ├── EFCore/              # EF Core 實作
│   │   ├── Dapper/              # Dapper 實作
│   │   └── ADO/                 # ADO.NET 實作
│   └── Logging/                  # 日誌實作
│
└── Extensions/                    # 擴充方法
    └── ServiceCollectionExtensions.cs # DI 容器註冊擴充
```

## 核心概念

1. **資料存取策略**
   - 支援多種資料庫存取方式（EF Core、Dapper、ADO.NET）
   - 同時支援同步和非同步操作
   - 統一的介面定義

2. **交易管理**
   - 自動交易管理
   - 支援交易範圍
   - 錯誤自動回滾

3. **日誌記錄**
   - 完整的操作日誌
   - 錯誤追蹤
   - 效能監控

## 使用方式

1. **基本使用**
```csharp
// 注入依賴
services.AddDataAccess(options => {
    options.UseDatabase(DatabaseType.SqlServer, connectionString);
});

// 使用儲存庫
public class UserService
{
    private readonly IBaseDataAccessAsync<User> _repository;

    public async Task CreateUser(User user)
    {
        await _repository.ExecuteInTransactionAsync(async () => {
            return await _repository.AddAsync(user);
        });
    }
}
```

2. **自定義儲存庫**
```csharp
public class CustomRepository<T> : BaseRepository<T> where T : class
{
    // 實作特定資料庫的邏輯
}
```

## 擴展性

1. **新增資料庫支援**
   - 實作 IDataAccessStrategy 介面
   - 實作對應的 Repository 類別

2. **自定義日誌記錄**
   - 實作 ILogger 介面
   - 整合現有的日誌框架

3. **效能優化**
   - 實作快取機制
   - 批次處理
   - 查詢優化

## 最佳實踐

1. **交易管理**
   - 使用 ExecuteInTransaction 方法確保資料一致性
   - 適當的交易範圍

2. **錯誤處理**
   - 使用 try-catch 處理特定異常
   - 記錄詳細的錯誤資訊

3. **效能考量**
   - 適當的查詢條件
   - 避免過大的交易範圍
   - 使用非同步方法處理 I/O 操作

## 注意事項

1. **交易範圍**
   - 避免過長的交易
   - 注意交易隔離級別

2. **資源釋放**
   - 正確使用 using 語句
   - 實作 IDisposable 介面

3. **效能監控**
   - 監控查詢效能
   - 追蹤慢查詢
   - 定期檢查日誌
