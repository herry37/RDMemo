# CrossPlatformDataAccess 跨平台資料存取層

## 專案結構

```
CrossPlatformDataAccess/
├── Core/                           # 核心層：定義介面和抽象
│   └── DataAccess/                # 資料存取相關介面
│       ├── IBaseDataAccess.cs     # 基礎資料存取介面（CRUD操作）
│       ├── IDataAccessStrategy.cs # 資料存取策略介面
│       └── IQueryBuilder.cs       # 查詢建構器介面
└── Infrastructure/                # 基礎設施層：實作核心層定義的介面
    └── DataAccess/               # 資料存取相關實作
        └── EFCore/               # Entity Framework Core 實作
            ├── EFCoreDataAccessStrategy.cs  # EF Core資料存取策略
            └── EFCoreQueryBuilder.cs        # EF Core查詢建構器
```

## 核心概念

### 1. 資料存取介面 (IBaseDataAccess)
- 定義基本的CRUD操作
- 支援同步和非同步操作
- 泛型設計，可用於任何實體類型

### 2. 資料存取策略 (IDataAccessStrategy)
- 定義資料庫操作的策略介面
- 支援連線管理
- 支援交易管理
- 提供SQL查詢執行功能
- 整合查詢建構器

### 3. 查詢建構器 (IQueryBuilder)
- 提供流暢的API來建構複雜查詢
- 支援條件查詢（Where）
- 支援關聯查詢（Include）
- 支援排序（OrderBy）
- 支援分頁（Page）

## 使用方式

### 基本CRUD操作
```csharp
// 注入資料存取介面
private readonly IBaseDataAccess<User> _userDataAccess;

// 查詢操作
var user = await _userDataAccess.GetByIdAsync(1);
var allUsers = await _userDataAccess.GetAllAsync();

// 新增
var newUser = await _userDataAccess.AddAsync(user);

// 更新
await _userDataAccess.UpdateAsync(user);

// 刪除
await _userDataAccess.DeleteAsync(user);
```

### 使用查詢建構器
```csharp
// 注入資料存取策略
private readonly IDataAccessStrategy _strategy;

// 使用查詢建構器
var users = await _strategy.Query<User>()
    .Where(u => u.Age > 18)
    .Include(u => u.Orders)
    .OrderBy(u => u.Name)
    .Page(1, 10)
    .ToListAsync();
```

### 使用交易
```csharp
using (var transaction = await _strategy.BeginTransactionAsync())
{
    try
    {
        // 執行資料庫操作
        await _userDataAccess.AddAsync(user);
        await _orderDataAccess.AddAsync(order);

        // 提交交易
        await transaction.CommitAsync();
    }
    catch
    {
        // 發生錯誤時回滾交易
        await transaction.RollbackAsync();
        throw;
    }
}
```

## 擴展性

### 1. 新增資料庫支援
- 實作 IDataAccessStrategy 介面
- 實作 IQueryBuilder 介面
- 實作 ITransactionScope 介面

### 2. 自定義查詢功能
- 擴展 IQueryBuilder 介面
- 在對應的實作類中添加新功能

## 最佳實踐

1. 使用依賴注入
2. 善用交易管理
3. 適當使用非同步操作
4. 注意資源釋放
5. 使用參數化查詢防止SQL注入
